hostname BORDERLEAF1
!
spanning-tree mode mstp
no spanning-tree vlan-id 4094
!
service routing protocols model multi-agent
!
system l1
   unsupported speed action error
   unsupported error-correction action error
!
vlan 100
   name MLAG_L1-L2
!
vlan 200 
   name MLAG_L3-L4
!
vlan 300
   name MLAG_hosts
!
vlan 4094
   name MLAG_Peer_Link
   trunk group MLAGPEER
!
vrf instance VXLAN_VRF
!
vrf instance MGMT
!
management api http-commands
   no shutdown
   !
   vrf MGMT
      no shutdown
!
aaa authorization exec default local
!
interface Port-Channel1
   description MLAG Peer-link to Borderleaf2
   switchport trunk allow vlan 100,200,300,4094
   switchport mode trunk
   switchport trunk group MLAGPEER
!
interface Ethernet1
   description MLAG Peer-link to Borderleaf2
   channel-group 1 mode active
!
interface Ethernet2
   description MLAG Peer-link to Borderleaf2
   channel-group 1 mode active
!
interface Ethernet3
   description Connection to Spine1 - eth6
   no switchport
   ip address 172.16.254.9/31
!
interface Ethernet4
   description Connection to Spine2 - eth6
   no switchport
   ip address 172.16.254.21/31
!
interface Ethernet5
desc Connection to Spine3 - eth5
no switchport
ip add 172.16.254.33/31
no shut
!
interface Ethernet6
   description MLAG Peer-link to Borderleaf2
   channel-group 1 mode active
!
interface Ethernet7
!
interface Loopback0
   description Loopback 0 for VTEP
   ip address 172.16.0.201/32
!
interface Loopback1
   description Loopback 1 for VTEP
   ip address 172.16.1.201/32
!
interface Management0
   vrf MGMT
   ip address 172.100.100.108/24
!
interface Vlan100
   description VNI for VLAN 1010
   ip address 172.16.101.1/24
   no ip virtual-router address 172.16.101.1
!
interface Vlan200
   description VNI for VLAN 1020
   ip address 172.16.102.1/24
   no ip virtual-router address 172.16.102.1
!
interface Vlan300
   description VNI for VLAN 1030
   ip address 172.16.103.1/24
   no ip virtual-router address 172.16.103.1
!
interface Vlan4094
   description VNI for vxlan 4094
   ip address 172.16.255.9/30
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 8004
   vxlan vlan 100 vni 1010
   vxlan vlan 200 vni 1020
   vxlan vlan 300 vni 1030
   vxlan vrf VXLAN_VRF vni 6666
   exit
!
ip virtual-router mac-address 00:01:00:02:00:06
!
ip routing
no ip routing vrf MGMT
ip routing vrf VXLAN_VRF
!
mlag configuration
   domain-id MLAG
   local-interface Vlan4094
   peer-address 172.16.255.10
   peer-link Port-Channel1
!
ip route vrf MGMT 0.0.0.0/0 172.100.100.1
!
router bgp 65500
   maximum-paths 4 ecmp 4
   neighbor EVPN peer group
   neighbor EVPN update-source Loopback0
   neighbor EVPN ebgp-multihop
   neighbor EVPN send-community
   neighbor EVPN maximum-routes 0
   neighbor spines peer group
   neighbor spines remote-as 65000
   neighbor spines maximum-routes 12000
   neighbor 172.16.0.202 peer group EVPN
   neighbor 172.16.0.202 remote-as 65500
   neighbor 172.16.254.8 peer group spines
   neighbor 172.16.254.20 peer group spines
   neighbor 172.16.254.32 peer group spines
   neighbor 172.16.0.101 peer group EVPN
   neighbor 172.16.0.102 peer group EVPN
   neighbor 172.16.0.103 peer group EVPN
   neighbor 172.16.255.10 remote-as 65500
   neighbor 172.16.255.10 update-source Vlan4094
   neighbor 172.16.255.10 maximum-routes 12000
   redistribute connected
   redistribute static
   !
   vlan 100
      rd 172.16.0.201:100
      route-target both 100:1010
      redistribute learned
   !
   vlan 200
      rd 172.16.0.201:200
      route-target both 200:1020
      redistribute learned
   !
   vlan 300
      rd 172.16.0.201:300
      route-target both 300:1030
      redistribute learned
   !
   address-family evpn
      bgp next-hop-unchanged
      neighbor EVPN activate
   !
   address-family ipv4
      no neighbor EVPN activate
      network 172.16.0.202/32
      network 172.16.1.201/32
      neighbor underlay_ibgp activate
   !
   vrf VXLAN_VRF
      rd 172.16.0.201:6666
      route-target import EVPN 100:6666
      route-target import EVPN 200:6666
      route-target import EVPN 300:6666
      route-target export EVPN 100:6666
      route-target export EVPN 200:6666
      redistribute connected
!
end
